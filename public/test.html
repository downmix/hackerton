<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <style>
    #btnAddBookCle{
      display: none;
    }
    #addBookInput{
      display: none;
    }

  </style>
</head>
<body>
  <div class="container">
    <div>
      <h3>Book List</h3>

      <table id="bookTable" class="table table-striped">
        <tr class="bookTableHeader">
          <th><input type="checkbox" id="bookCkAll"></th>
          <th>#</th>
          <th>Title</th>
          <th>Author</th>
          <th>Price</th>
        </tr>
        <tbody id="bookTableBody">
          
        </tbody>
      </table>
      <input id="btnDelBook" class="btn btn-default" type="button" value="Delete Book">
      <input id="btnAddBook" class="btn btn-default" type="button" value="Add Book">
      <input id="btnAddBookCle" class="btn btn-default" type="button" value="Cancle">
      
      <div id="addBookInput">
        <label class="control-label" for="inputId">Title</label>
        <input id="inputId" class="form-control" type="text" placeholder="Title..">
        <label class="control-label" for="inputAut">Author</label>
        <input id="inputAut" class="form-control" type="text" placeholder="Author..">
        <label class="control-label" for="inputAut">Price</label>
        <input id="inputPri" class="form-control" type="text" placeholder="Price..">
      </div>
    </div>
  </div>
   
  <script>
    let temp = `{
    "default": {
        "timelineData": [
            {
                "time": "1501545600",
                "formattedTime": "Aug 1, 2017",
                "formattedAxisTime": "Aug 1",
                "value": [
                    49,
                    33
                ],
                "formattedValue": [
                    "49",
                    "33"
                ]
            },
            {
                "time": "1501632000",
                "formattedTime": "Aug 2, 2017",
                "formattedAxisTime": "Aug 2",
                "value": [
                    0,
                    32
                ],
                "formattedValue": [
                    "0",
                    "32"
                ]
            },
            {
                "time": "1501718400",
                "formattedTime": "Aug 3, 2017",
                "formattedAxisTime": "Aug 3",
                "value": [
                    33,
                    0
                ],
                "formattedValue": [
                    "33",
                    "0"
                ]
            },
            {
                "time": "1501804800",
                "formattedTime": "Aug 4, 2017",
                "formattedAxisTime": "Aug 4",
                "value": [
                    51,
                    0
                ],
                "formattedValue": [
                    "51",
                    "0"
                ]
            },
            {
                "time": "1501891200",
                "formattedTime": "Aug 5, 2017",
                "formattedAxisTime": "Aug 5",
                "value": [
                    38,
                    38
                ],
                "formattedValue": [
                    "38",
                    "38"
                ]
            },
            {
                "time": "1501977600",
                "formattedTime": "Aug 6, 2017",
                "formattedAxisTime": "Aug 6",
                "value": [
                    37,
                    37
                ],
                "formattedValue": [
                    "37",
                    "37"
                ]
            },
            {
                "time": "1502064000",
                "formattedTime": "Aug 7, 2017",
                "formattedAxisTime": "Aug 7",
                "value": [
                    47,
                    31
                ],
                "formattedValue": [
                    "47",
                    "31"
                ]
            },
            {
                "time": "1502150400",
                "formattedTime": "Aug 8, 2017",
                "formattedAxisTime": "Aug 8",
                "value": [
                    63,
                    31
                ],
                "formattedValue": [
                    "63",
                    "31"
                ]
            },
            {
                "time": "1502236800",
                "formattedTime": "Aug 9, 2017",
                "formattedAxisTime": "Aug 9",
                "value": [
                    32,
                    0
                ],
                "formattedValue": [
                    "32",
                    "0"
                ]
            },
            {
                "time": "1502323200",
                "formattedTime": "Aug 10, 2017",
                "formattedAxisTime": "Aug 10",
                "value": [
                    32,
                    32
                ],
                "formattedValue": [
                    "32",
                    "32"
                ]
            },
            {
                "time": "1502409600",
                "formattedTime": "Aug 11, 2017",
                "formattedAxisTime": "Aug 11",
                "value": [
                    68,
                    0
                ],
                "formattedValue": [
                    "68",
                    "0"
                ]
            },
            {
                "time": "1502496000",
                "formattedTime": "Aug 12, 2017",
                "formattedAxisTime": "Aug 12",
                "value": [
                    57,
                    0
                ],
                "formattedValue": [
                    "57",
                    "0"
                ]
            },
            {
                "time": "1502582400",
                "formattedTime": "Aug 13, 2017",
                "formattedAxisTime": "Aug 13",
                "value": [
                    36,
                    0
                ],
                "formattedValue": [
                    "36",
                    "0"
                ]
            },
            {
                "time": "1502668800",
                "formattedTime": "Aug 14, 2017",
                "formattedAxisTime": "Aug 14",
                "value": [
                    65,
                    0
                ],
                "formattedValue": [
                    "65",
                    "0"
                ]
            },
            {
                "time": "1502755200",
                "formattedTime": "Aug 15, 2017",
                "formattedAxisTime": "Aug 15",
                "value": [
                    0,
                    34
                ],
                "formattedValue": [
                    "0",
                    "34"
                ]
            },
            {
                "time": "1502841600",
                "formattedTime": "Aug 16, 2017",
                "formattedAxisTime": "Aug 16",
                "value": [
                    0,
                    0
                ],
                "formattedValue": [
                    "0",
                    "0"
                ]
            },
            {
                "time": "1502928000",
                "formattedTime": "Aug 17, 2017",
                "formattedAxisTime": "Aug 17",
                "value": [
                    100,
                    0
                ],
                "formattedValue": [
                    "100",
                    "0"
                ]
            },
            {
                "time": "1503014400",
                "formattedTime": "Aug 18, 2017",
                "formattedAxisTime": "Aug 18",
                "value": [
                    34,
                    0
                ],
                "formattedValue": [
                    "34",
                    "0"
                ]
            },
            {
                "time": "1503100800",
                "formattedTime": "Aug 19, 2017",
                "formattedAxisTime": "Aug 19",
                "value": [
                    0,
                    0
                ],
                "formattedValue": [
                    "0",
                    "0"
                ]
            },
            {
                "time": "1503187200",
                "formattedTime": "Aug 20, 2017",
                "formattedAxisTime": "Aug 20",
                "value": [
                    71,
                    0
                ],
                "formattedValue": [
                    "71",
                    "0"
                ]
            },
            {
                "time": "1503273600",
                "formattedTime": "Aug 21, 2017",
                "formattedAxisTime": "Aug 21",
                "value": [
                    33,
                    0
                ],
                "formattedValue": [
                    "33",
                    "0"
                ]
            }
        ],
        "averages": [
            40,
            13
        ]
    }
}`;

    /*------------------------------------*/
    /* 도서 리스트 출력, 삭제, 입력 구현 */
    /* NO 통신 >> Ajax통신 컨버전 */
    let bookList;
    const req = new XMLHttpRequest();
    
    /*------------------------------------*/
    /* [ 리스트 JONS 리플래시 ] */
    const bookListLoad = () => {
      req.open('GET', '/echo', true);
      req.send();

      req.onreadystatechange = function() {
        if(req.readyState === XMLHttpRequest.DONE){
          if(req.status == 200){
            console.log(req.responseText);
            //bookList = JSON.parse(req.responseText);
            //bookListCall();
          }
        }
      }
    };
    
    /*------------------------------------*/
    /* [ JSON을 가공 > DOM 입력 ] */
    const bookListCall = () => {
      let bookListHtml = '';
      bookList.map(book => {
        bookListHtml += `<tr>
          <td><input type="checkbox" id="${book.id}"></td>
          <th>${book.id}</th>
          <td>${book.title}</td>
          <td>${book.author}</td>
          <td>${book.price}</td>
        </tr>`;
      });

      document.getElementById('bookTableBody').innerHTML = bookListHtml;
    };

    /*------------------------------------*/
    /* [ 버튼 add Book ] */
    document.getElementById('btnAddBook').addEventListener('click', () => {
      let addBookInputFlg = document.getElementById('addBookInput').style.display;
      
      if(!addBookInputFlg || addBookInputFlg == 'none' ){
        document.getElementById('btnAddBookCle').style.display = 'inline';
        document.getElementById('addBookInput').style.display = 'block';
      }else{
        if(!document.getElementById('inputId').value){
          alert('title은 필수입니다.');
          return;
        }

        let addBook = {};
        const list = [...document.querySelectorAll('#addBookInput input[type=text]')].map(val => {
          let bookListCnt = bookList.length < 1 ? 0 : bookList[bookList.length-1].id;
          
          addBook.id = Math.max(bookListCnt) + 1;
          if(val.id == 'inputId'){
            addBook.title = val.value;
          }else if(val.id == 'inputAut'){
            addBook.author = val.value;
          }else if(val.id == 'inputPri'){
            addBook.price = val.value;
          }

          return addBook;
        })

        req.open('POST', '/bookList', true);
        req.setRequestHeader('Content-type', 'application/json');
        req.send(JSON.stringify(addBook));
        
        req.onreadystatechange = function() {
          if(req.readyState === XMLHttpRequest.DONE){
            if(req.status == 201){
              console.log(req.responseText);
              const addBookInput = [...document.querySelectorAll('#addBookInput input[type=text]')].map(val => {
                val.value = '';
              });
              bookListLoad();
            }
          }
        }
      }
    })

    /*------------------------------------*/
    /* [ 버튼 cancle 책입력 가리기 ] */
    document.getElementById('btnAddBookCle').addEventListener('click', () => {
      document.getElementById('btnAddBookCle').style.display = 'none';
      document.getElementById('addBookInput').style.display = 'none';
    })

    /*------------------------------------*/
    /* [ 리스트 전체선택 ] */
    document.getElementById('bookCkAll').addEventListener('click', (e) => {
      [...document.querySelectorAll('#bookTable td input[type=checkbox]')].map(val => {
        val.checked = e.target.checked;
      });
    });

    /*------------------------------------*/
    /* [ book 제거 > 체크박스 선택된 항목 ] */
    document.getElementById('btnDelBook').addEventListener('click', () => {
      let delBookList = [...document.querySelectorAll('#bookTable td input[type=checkbox]:checked')].map(val => {
        return parseInt(val.id);
      });
      
      console.log(delBookList);
      bookList = bookList.filter(val => {
        return delBookList.indexOf(val.id) < 0;
      });

      delBookList.map(val => {
        req.open('DELETE', `/bookList/${val}`, true);
        req.send();

        req.onreadystatechange = function() {
          if(req.readyState === XMLHttpRequest.DONE){
            if(req.status == 200){
              console.log(req.responseText);
            }
          }
        }
      });

      bookListCall();
    });

    /*------------------------------------*/
    /* [ start ] */
    bookListLoad();
  </script>
</body>
</html>